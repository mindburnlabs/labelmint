apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: labelmintit-base
  annotations:
    config.kubernetes.io/local-config: "true"

namespace: default

commonLabels:
  app: labelmintit
  managed-by: kustomize

commonAnnotations:
  app.kubernetes.io/version: "v1.0.0"
  app.kubernetes.io/component: "backend"
  app.kubernetes.io/part-of: "labelmintit"

resources:
  - deployment.yaml
  - service.yaml
  - ingress.yaml
  - configmap.yaml
  - secrets.yaml
  - hpa.yaml
  - pdb.yaml

patchesStrategicMerge:
  - deployment-patch.yaml

replicas:
  - name: labelmintit
    count: 3

images:
  - name: labelmintit/app
    newTag: latest

configMapGenerator:
  - name: labelmintit-config
    literals:
      - NODE_ENV=production
      - LOG_LEVEL=info
      - PORT=3000
      - METRICS_PORT=9090

secretGenerator:
  - name: labelmintit-generated-secrets
    literals:
      - SESSION_SECRET=$(openssl rand -base64 32)
      - JWT_SECRET=$(openssl rand -base64 64)

vars:
  - name: CONFIGMAP_CHECKSUM
    objref:
      kind: ConfigMap
      name: labelmintit-config
      apiVersion: v1
    fieldref:
      fieldpath: metadata.annotations.checksum/config
  - name: SECRET_CHECKSUM
    objref:
      kind: Secret
      name: labelmintit-secrets
      apiVersion: v1
    fieldref:
      fieldpath: metadata.annotations.checksum/secret

patchesJson6902:
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: labelmintit
    patch: |-
      - op: replace
        path: /spec/template/metadata/annotations/checksum~1config
        value: $(CONFIGMAP_CHECKSUM)
      - op: replace
        path: /spec/template/metadata/annotations/checksum~1secret
        value: $(SECRET_CHECKSUM)