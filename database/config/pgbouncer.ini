# PgBouncer Configuration for DeligeIT
# Connection Pooler for PostgreSQL

[databases]
# Database connection definitions
labelmintit_main = host=labelmintit-db.cluster-ro-c1j7xfoie2.us-east-1.rds.amazonaws.com port=5432 dbname=labelmintit
labelmintit_replica = host=labelmintit-db-read.cluster-ro-c1j7xfoie2.us-east-1.rds.amazonaws.com port=5432 dbname=labelmintit
labelmintit_analytics = host=labelmintit-analytics.cluster-12345.us-east-1.rds.amazonaws.com port=5432 dbname=labelmintit_analytics

[users]
# User definitions
labelmintit_user = password=<ENCRYPTED_PASSWORD>
labelmintit_readonly = password=<ENCRYPTED_READONLY_PASSWORD>
labelmintit_analytics = password=<ENCRYPTED_ANALYTICS_PASSWORD>

[pgbouncer]
# General settings
listen_port = 6432
listen_addr = 127.0.0.1
admin_users = postgres,pgbouncer
stats_users = stats,pgbouncer

# Connection pool settings
pool_mode = transaction
max_client_conn = 200
default_pool_size = 25
min_pool_size = 10
reserve_pool_size = 5
reserve_pool_timeout = 5
max_db_connections = 100
max_user_connections = 50

# Query timeout settings
query_timeout = 600
query_wait_timeout = 120
client_idle_timeout = 600
client_login_timeout = 60
idle_timeout = 30

# Transaction handling
track_activities = yes
track_counts = yes
track_io_timing = yes
track_function_arguments = yes
server_reset_query_always = 0
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

# Server settings
server_check_delay = 5
server_check_query = select 1
server_lifetime = 3600
server_idle_timeout = 600

# Packet settings
pkt_buf = 4096
max_packet_size = 16384
tcp_defer_accept = 0

# TLS/SSL settings
client_tls_sslmode = require
server_tls_sslmode = verify-ca
tls_ca_file = /etc/ssl/rds-ca-2019-root.pem

# Authentication settings
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Logging settings
syslog = 0
syslog_facility = daemon
syslog_ident = pgbouncer
log_line_prefix = %t [%p]: [%u][%d]

# Performance tuning
tcp_socket_buffer = 4KB
so_reuseport = 1
tcp_keepalive = 1
tcp_keepcnt = 9
tcp_keepidle = 7200
tcp_keepintvl = 75
tcp_user_timeout = 0

# Application name for monitoring
application_name = deligeit_backend

# Query blocklist (prevent slow or dangerous queries)
# Format: dbname,user,query
query_blocklist = \
    deligeit_main,labelmintit_user,UPDATE users SET password = '' WHERE id = \
    deligeit_main,labelmintit_user,SELECT * FROM users WHERE password = '' OR '1'='1 \
    deligeit_main,labelmintit_user,INSERT INTO users (password) VALUES (''); DROP TABLE users; -- \
    deligeit_main,labelmintit_analytics,SELECT * FROM analytics WHERE 1=1 UNION SELECT * FROM sensitive_data

# Query blocklist for regex patterns
query_blocklist_regexp = \
    (SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|TRUNCATE) (password|token|key|secret)
    (\.\.[\/\\\\])+(\.|\)|^(/|\\\\)
    ((\%27)|(\')|(--))|((\%27)|(\'))|((\%27)|(\'))

# Server blocklist (prevent connections to suspicious servers)
# Format: ip:port
server_blocklist = \
    192.168.100.100:5432
    10.0.0.50:5432

# Rate limiting per user
rate_limit_enabled = 1
rate_limit_rate = 100  # queries per second
rate_limit_per_user = 1
rate_limit_per_ip = 1
rate_limit_hourly = 1000  # queries per hour
rate_limit_userlist = root,postgres

# Connection limits per IP
host_limit_enabled = 1
host_limit_per_host = 50
host_limit_min_duration = 1  # minimum 1 second
host_limit_per_connection = 0
host_limit_per_query = 10  # queries per connection
host_limit_qps = 100  # queries per second
host_limit_exception = 127.0.0.1/32,::1

# Auto-ban settings for violations
auto_ban_enabled = 1
auto_ban_threshold = 100  # ban after 100 violations
auto_ban_duration = 300  # ban for 5 minutes
auto_ban_userlist = admin,postgres

# Database health check settings
health_check_enabled = 1
health_check_interval = 10
health_check_connect_timeout = 3
health_check_query = SELECT 1
health_check_database = deligeit_main

# Metrics and monitoring
prometheus_enabled = 1
prometheus_endpoint = 0.0.0.0:9188
prometheus_stats = True
prometheus_per_database = True
prometheus_per_user = True
prometheus_query_timeout = False

# Prepared statements
prepared_statements = 1
prepare_threshold = 5

# Connection latency settings
latency_threshold = 100
latency_slow_query = 100

# Connection retry settings
connect_retry = 3
connect_retry_delay = 1
connect_retry_random_delay = 0

# Connection pool draining (for maintenance)
pool_drain_enabled = 1
pool_drain_timeout = 30
pool_drain_min_connections = 2

# Query size limits
query_size_limit = 1048576  # 1MB
result_size_limit = 1048576  # 1MB
packet_size_limit = 16384

# Connection validation
validate_connection = 1
validate_user = 1
validate_password = 1
validate_database = 1

# Logging levels
log_connections = 1
log_disconnections = 1
log_errors = 1
log_warnings = 1
log_info = 0
log_debug = 0

# Performance monitoring
track_session_time = 1
track_io_timing = 1
track_bytes_received = 1
track_bytes_sent = 1
track_timestamp = 1

# Security headers
set_protection_header = 1
security_headers = X-Content-Type-Options: nosniff; X-Frame-Options: DENY; X-XSS-Protection: 1; mode=block; reportUri=/xss-report