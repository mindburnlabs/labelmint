# HAProxy configuration for database load balancing

global
    log stdout format raw local0
    maxconn 4096
    nbproc 1

defaults
    log global
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option tcplog
    option dontlognull
    retries 3

# Frontend for read/write operations (primary only)
frontend primary_write
    bind *:5400
    default_backend primary_servers

# Frontend for read operations (all servers)
frontend read_only
    bind *:5401
    default_backend read_servers

# Backend for primary server (writes)
backend primary_servers
    balance first
    option tcp-check
    server postgres-primary postgres-primary:5432 check inter 1s rise 2 fall 3
    # Failover to replica1 if primary fails (emergency only)
    server postgres-replica-1 postgres-replica-1:5432 check inter 1s rise 2 fall 3 backup

# Backend for read operations (load balanced)
backend read_servers
    balance roundrobin
    option tcp-check
    # Primary for reads (less preferred)
    server postgres-primary postgres-primary:5432 check inter 1s rise 2 fall 3 weight 10
    # Replicas for reads (preferred)
    server postgres-replica-1 postgres-replica-1:5432 check inter 1s rise 2 fall 3 weight 100
    server postgres-replica-2 postgres-replica-2:5432 check inter 1s rise 2 fall 3 weight 100

# Statistics page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE